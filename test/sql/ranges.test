# name: test/sql/ranges.test
# description: test ranges extension
# group: [ranges]

# Before we load the extension, this will fail
statement error
SELECT int4range(1, 5);
----
Catalog Error: Scalar Function with name int4range does not exist!

# Require statement will ensure this test is run with this extension loaded
require ranges

# Test basic construction and display
query I
SELECT int4range(1, 5, '[)');
----
[1,5)

query I
SELECT int4range(1, 5, '[]');
----
[1,5]

query I
SELECT int4range(1, 5, '()');
----
(1,5)

query I
SELECT int4range(1, 5, '(]');
----
(1,5]

# Test empty ranges
query I
SELECT int4range(5, 1, '[)');
----
empty

query I
SELECT int4range(1, 1, '()');
----
empty

query I
SELECT int4range(1, 1, '[)');
----
empty

query I
SELECT int4range(1, 1, '(]');
----
empty

query I
SELECT int4range(1, 1, '[]');
----
[1,1]

# Test with negative numbers
query I
SELECT int4range(-10, -5, '[)');
----
[-10,-5)

query I
SELECT int4range(-5, 5, '[]');
----
[-5,5]

# Test with zero
query I
SELECT int4range(0, 10, '[)');
----
[0,10)

query I
SELECT int4range(-10, 0, '(]');
----
(-10,0]

# Test overlaps - basic cases
query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(3, 7, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(5, 10, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(5, 10, '[]'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(6, 10, '[)'));
----
false

# Test overlaps - edge cases with different bound combinations
query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(5, 10, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(5, 10, '[]'));
----
false

query I
SELECT range_overlaps(int4range(1, 5, '(]'), int4range(5, 10, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '()'), int4range(5, 10, '()'));
----
false

# Test overlaps - complete overlap
query I
SELECT range_overlaps(int4range(1, 10, '[)'), int4range(3, 7, '[)'));
----
true

query I
SELECT range_overlaps(int4range(3, 7, '[)'), int4range(1, 10, '[)'));
----
true

# Test overlaps - identical ranges
query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(1, 5, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(1, 5, '[]'));
----
true

# Test overlaps - with empty ranges
query I
SELECT range_overlaps(int4range(5, 1, '[)'), int4range(1, 10, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 10, '[)'), int4range(5, 1, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 1, '()'), int4range(1, 5, '[)'));
----
false

# Test overlaps - negative numbers
query I
SELECT range_overlaps(int4range(-10, -5, '[)'), int4range(-7, -3, '[)'));
----
true

query I
SELECT range_overlaps(int4range(-10, -5, '[)'), int4range(-5, 0, '[)'));
----
false

query I
SELECT range_overlaps(int4range(-10, 0, '[]'), int4range(0, 10, '[]'));
----
true

# Test NULLs
query I
SELECT int4range(NULL, 5, '[)');
----
NULL

query I
SELECT int4range(1, NULL, '[)');
----
NULL

query I
SELECT int4range(1, 5, NULL);
----
NULL

query I
SELECT range_overlaps(NULL, int4range(1, 5, '[)'));
----
NULL

query I
SELECT range_overlaps(int4range(1, 5, '[)'), NULL);
----
NULL

query I
SELECT range_overlaps(NULL::INT4RANGE, NULL::INT4RANGE);
----
NULL

# Test invalid bounds string (should error)
statement error
SELECT int4range(1, 5, 'invalid');
----
Invalid bounds: invalid

# Test that empty string defaults to [)
query I
SELECT int4range(1, 5, '');
----
[1,5)

# Test casting to VARCHAR works
query I
SELECT int4range(10, 20, '[]')::VARCHAR;
----
[10,20]

query I
SELECT int4range(10, 20, '()')::VARCHAR;
----
(10,20)

# Test range_contains function
query I
SELECT range_contains(int4range(1, 10, '[)'), 5);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 1);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 10);
----
false

query I
SELECT range_contains(int4range(1, 10, '[]'), 10);
----
true

query I
SELECT range_contains(int4range(1, 10, '()'), 1);
----
false

query I
SELECT range_contains(int4range(1, 10, '(]'), 10);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 0);
----
false

query I
SELECT range_contains(int4range(1, 10, '[)'), 11);
----
false

# Test range_contains with negative numbers
query I
SELECT range_contains(int4range(-10, 0, '[)'), -5);
----
true

query I
SELECT range_contains(int4range(-10, 0, '[)'), 0);
----
false

query I
SELECT range_contains(int4range(-10, 0, '[]'), 0);
----
true

# Test range_contains with empty ranges
query I
SELECT range_contains(int4range(5, 1, '[)'), 3);
----
false

# Test range_contains with NULL
query I
SELECT range_contains(NULL, 5);
----
NULL

query I
SELECT range_contains(int4range(1, 10, '[)'), NULL);
----
NULL

# Test @> operator (contains)
query I
SELECT int4range(1, 10, '[)') @> 5;
----
true

query I
SELECT int4range(1, 10, '[)') @> 1;
----
true

query I
SELECT int4range(1, 10, '[)') @> 10;
----
false

query I
SELECT int4range(1, 10, '[]') @> 10;
----
true

query I
SELECT int4range(1, 10, '()') @> 1;
----
false

query I
SELECT int4range(1, 10, '(]') @> 10;
----
true

query I
SELECT int4range(1, 10, '[)') @> 0;
----
false

query I
SELECT int4range(1, 10, '[)') @> 11;
----
false

# Test @> with negative numbers
query I
SELECT int4range(-10, 0, '[)') @> -5;
----
true

query I
SELECT int4range(-10, 0, '[)') @> 0;
----
false

query I
SELECT int4range(-10, 0, '[]') @> 0;
----
true

# Test @> with empty ranges
query I
SELECT int4range(5, 1, '[)') @> 3;
----
false

query I
SELECT int4range('empty') @> 5;
----
false

# Test @> with NULL
query I
SELECT NULL::INT4RANGE @> 5;
----
NULL

query I
SELECT int4range(1, 10, '[)') @> NULL;
----
NULL

# Test <@ operator (contained by)
query I
SELECT 5 <@ int4range(1, 10, '[)');
----
true

query I
SELECT 1 <@ int4range(1, 10, '[)');
----
true

query I
SELECT 10 <@ int4range(1, 10, '[)');
----
false

query I
SELECT 10 <@ int4range(1, 10, '[]');
----
true

query I
SELECT 1 <@ int4range(1, 10, '()');
----
false

query I
SELECT 10 <@ int4range(1, 10, '(]');
----
true

query I
SELECT 0 <@ int4range(1, 10, '[)');
----
false

query I
SELECT 11 <@ int4range(1, 10, '[)');
----
false

# Test <@ with negative numbers
query I
SELECT -5 <@ int4range(-10, 0, '[)');
----
true

query I
SELECT 0 <@ int4range(-10, 0, '[)');
----
false

query I
SELECT 0 <@ int4range(-10, 0, '[]');
----
true

# Test <@ with empty ranges
query I
SELECT 3 <@ int4range(5, 1, '[)');
----
false

query I
SELECT 5 <@ int4range('empty');
----
false

# Test <@ with NULL
query I
SELECT NULL <@ int4range(1, 10, '[)');
----
NULL

query I
SELECT 5 <@ NULL::INT4RANGE;
----
NULL

# Test operators in WHERE clause
query I
SELECT * FROM (VALUES (1), (5), (10), (15)) t(x) WHERE x <@ int4range(1, 10, '[)');
----
1
5

query I
SELECT * FROM (VALUES (1), (5), (10), (15)) t(x) WHERE int4range(1, 10, '[]') @> x;
----
1
5
10

# Test 2-argument constructor (defaults to '[)')
query I
SELECT int4range(1, 5);
----
[1,5)

query I
SELECT int4range(10, 20);
----
[10,20)

query I
SELECT int4range(-5, 5);
----
[-5,5)

# Test lower() accessor
query I
SELECT lower(int4range(1, 10, '[)'));
----
1

query I
SELECT lower(int4range(-5, 5, '[]'));
----
-5

query I
SELECT lower(int4range(100, 200, '()'));
----
100

# Test upper() accessor
query I
SELECT upper(int4range(1, 10, '[)'));
----
10

query I
SELECT upper(int4range(-5, 5, '[]'));
----
5

query I
SELECT upper(int4range(100, 200, '()'));
----
200

# Test isempty() function
query I
SELECT isempty(int4range(1, 10, '[)'));
----
false

query I
SELECT isempty(int4range(5, 1, '[)'));
----
true

query I
SELECT isempty(int4range(1, 1, '[]'));
----
false

query I
SELECT isempty(int4range(1, 1, '[)'));
----
true

query I
SELECT isempty(int4range(1, 1, '()'));
----
true

# Test lower_inc() accessor
query I
SELECT lower_inc(int4range(1, 10, '[)'));
----
true

query I
SELECT lower_inc(int4range(1, 10, '()'));
----
false

query I
SELECT lower_inc(int4range(1, 10, '[]'));
----
true

query I
SELECT lower_inc(int4range(1, 10, '(]'));
----
false

# Test upper_inc() accessor
query I
SELECT upper_inc(int4range(1, 10, '[)'));
----
false

query I
SELECT upper_inc(int4range(1, 10, '()'));
----
false

query I
SELECT upper_inc(int4range(1, 10, '[]'));
----
true

query I
SELECT upper_inc(int4range(1, 10, '(]'));
----
true

# Test accessors with 2-arg constructor
query I
SELECT lower(int4range(5, 15));
----
5

query I
SELECT upper(int4range(5, 15));
----
15

query I
SELECT lower_inc(int4range(5, 15));
----
true

query I
SELECT upper_inc(int4range(5, 15));
----
false

# Test accessors with NULL
query I
SELECT lower(NULL::INT4RANGE);
----
NULL

query I
SELECT upper(NULL::INT4RANGE);
----
NULL

query I
SELECT isempty(NULL::INT4RANGE);
----
NULL

query I
SELECT lower_inc(NULL::INT4RANGE);
----
NULL

query I
SELECT upper_inc(NULL::INT4RANGE);
----
NULL

# Test 4-argument constructor
query I
SELECT int4range(1, 5, true, false);
----
[1,5)

query I
SELECT int4range(1, 5, true, true);
----
[1,5]

query I
SELECT int4range(1, 5, false, true);
----
(1,5]

query I
SELECT int4range(1, 5, false, false);
----
(1,5)

# Test 1-argument constructor and string casting
query I
SELECT int4range('[3,7)');
----
[3,7)

query I
SELECT int4range('(3,7)');
----
(3,7)

query I
SELECT int4range('[4,4]');
----
[4,4]

query I
SELECT int4range('[4,4)');
----
empty

query I
SELECT '[3,7)'::int4range;
----
[3,7)

query I
SELECT '(3,7)'::int4range;
----
(3,7)

query I
SELECT '[4,4]'::int4range;
----
[4,4]

query I
SELECT '[4,4)'::int4range;
----
empty

query I
SELECT 'empty'::int4range;
----
empty

query I
SELECT int4range('empty');
----
empty

statement error
SELECT int4range('invalid');
----
Malformed range literal: "invalid"

statement error
SELECT 'invalid'::int4range;
----
Malformed range literal: "invalid"


# Test consistency between constructors
query I
SELECT int4range(3, 7, '[)') = int4range('[3,7)');
----
true

query I
SELECT int4range(3, 7, false, false) = int4range('(3,7)');
----
true

#===--------------------------------------------------------------------===#
# NUMRANGE Tests
#===--------------------------------------------------------------------===#

# Test basic numrange construction with 3-arg constructor
query I
SELECT numrange(1.5, 5.5, '[)');
----
[1.500000,5.500000)

query I
SELECT numrange(1.0, 5.0, '[]');
----
[1.000000,5.000000]

query I
SELECT numrange(1.5, 5.5, '()');
----
(1.500000,5.500000)

query I
SELECT numrange(1.5, 5.5, '(]');
----
(1.500000,5.500000]

# Test 2-argument numrange constructor (defaults to '[)')
query I
SELECT numrange(1.5, 5.5);
----
[1.500000,5.500000)

query I
SELECT numrange(10.25, 20.75);
----
[10.250000,20.750000)

query I
SELECT numrange(-5.5, 5.5);
----
[-5.500000,5.500000)

# Test 4-argument numrange constructor
query I
SELECT numrange(1.5, 5.5, true, false);
----
[1.500000,5.500000)

query I
SELECT numrange(1.5, 5.5, true, true);
----
[1.500000,5.500000]

query I
SELECT numrange(1.5, 5.5, false, true);
----
(1.500000,5.500000]

query I
SELECT numrange(1.5, 5.5, false, false);
----
(1.500000,5.500000)

# Test numrange with negative numbers
query I
SELECT numrange(-10.5, -5.5, '[)');
----
[-10.500000,-5.500000)

query I
SELECT numrange(-5.5, 5.5, '[]');
----
[-5.500000,5.500000]

# Test numrange with zero
query I
SELECT numrange(0.0, 10.5, '[)');
----
[0.000000,10.500000)

query I
SELECT numrange(-10.5, 0.0, '(]');
----
(-10.500000,0.000000]

# Test empty numrange
query I
SELECT numrange(5.5, 1.5, '[)');
----
empty

query I
SELECT numrange(1.0, 1.0, '()');
----
empty

query I
SELECT numrange(1.0, 1.0, '[)');
----
empty

query I
SELECT numrange(1.0, 1.0, '(]');
----
empty

query I
SELECT numrange(1.0, 1.0, '[]');
----
[1.000000,1.000000]

# Test numrange_contains
query I
SELECT range_contains(numrange(1.0, 10.0, '[)'), 5.5);
----
true

query I
SELECT range_contains(numrange(1.0, 10.0, '[)'), 1.0);
----
true

query I
SELECT range_contains(numrange(1.0, 10.0, '[)'), 10.0);
----
false

query I
SELECT range_contains(numrange(1.0, 10.0, '[]'), 10.0);
----
true

query I
SELECT range_contains(numrange(1.0, 10.0, '()'), 1.0);
----
false

query I
SELECT range_contains(numrange(1.0, 10.0, '(]'), 10.0);
----
true

# Test numrange_contains with negative numbers
query I
SELECT range_contains(numrange(-10.5, 0.0, '[)'), -5.5);
----
true

query I
SELECT range_contains(numrange(-10.5, 0.0, '[)'), 0.0);
----
false

query I
SELECT range_contains(numrange(-10.5, 0.0, '[]'), 0.0);
----
true

# Test numrange @> operator
query I
SELECT numrange(1.0, 10.0, '[)') @> 5.5;
----
true

query I
SELECT numrange(1.0, 10.0, '[)') @> 1.0;
----
true

query I
SELECT numrange(1.0, 10.0, '[)') @> 10.0;
----
false

query I
SELECT numrange(1.0, 10.0, '[]') @> 10.0;
----
true

# Test numrange <@ operator
query I
SELECT 5.5 <@ numrange(1.0, 10.0, '[)');
----
true

query I
SELECT 1.0 <@ numrange(1.0, 10.0, '[)');
----
true

query I
SELECT 10.0 <@ numrange(1.0, 10.0, '[)');
----
false

query I
SELECT 10.0 <@ numrange(1.0, 10.0, '[]');
----
true

# Test numrange overlaps
query I
SELECT range_overlaps(numrange(1.0, 5.0, '[)'), numrange(3.0, 7.0, '[)'));
----
true

query I
SELECT range_overlaps(numrange(1.0, 5.0, '[)'), numrange(5.0, 10.0, '[)'));
----
false

query I
SELECT range_overlaps(numrange(1.0, 5.0, '[]'), numrange(5.0, 10.0, '[]'));
----
true

query I
SELECT range_overlaps(numrange(1.0, 5.0, '[)'), numrange(6.0, 10.0, '[)'));
----
false

# Test numrange accessors
query I
SELECT lower(numrange(1.5, 10.5, '[)'));
----
1.5

query I
SELECT upper(numrange(1.5, 10.5, '[)'));
----
10.5

query I
SELECT lower_inc(numrange(1.5, 10.5, '[)'));
----
true

query I
SELECT upper_inc(numrange(1.5, 10.5, '[)'));
----
false

query I
SELECT lower_inc(numrange(1.5, 10.5, '()'));
----
false

query I
SELECT upper_inc(numrange(1.5, 10.5, '[]'));
----
true

query I
SELECT isempty(numrange(1.5, 10.5, '[)'));
----
false

query I
SELECT isempty(numrange(5.5, 1.5, '[)'));
----
true

query I
SELECT isempty(numrange(1.0, 1.0, '[]'));
----
false

query I
SELECT isempty(numrange(1.0, 1.0, '[)'));
----
true

# Test numrange with NULL
query I
SELECT numrange(NULL, 5.5, '[)');
----
NULL

query I
SELECT numrange(1.5, NULL, '[)');
----
NULL

query I
SELECT numrange(1.5, 5.5, NULL);
----
NULL

query I
SELECT range_contains(NULL::NUMRANGE, 5.5);
----
NULL

query I
SELECT range_contains(numrange(1.5, 10.5, '[)'), NULL);
----
NULL

# Test numrange 1-argument constructor (string parsing)
query I
SELECT numrange('[3.5,7.5)');
----
[3.500000,7.500000)

query I
SELECT numrange('(3.5,7.5)');
----
(3.500000,7.500000)

query I
SELECT numrange('[4.0,4.0]');
----
[4.000000,4.000000]

query I
SELECT numrange('[4.0,4.0)');
----
empty

query I
SELECT numrange('empty');
----
empty

# Test numrange casting to VARCHAR
query I
SELECT numrange(10.5, 20.5, '[]')::VARCHAR;
----
[10.500000,20.500000]

query I
SELECT numrange(10.5, 20.5, '()')::VARCHAR;
----
(10.500000,20.500000)

# Test VARCHAR to numrange casting
query I
SELECT '[3.5,7.5)'::numrange;
----
[3.500000,7.500000)

query I
SELECT '(3.5,7.5)'::numrange;
----
(3.500000,7.500000)

query I
SELECT 'empty'::numrange;
----
empty

# Test consistency between numrange constructors
query I
SELECT numrange(3.5, 7.5, '[)') = numrange('[3.5,7.5)');
----
true

query I
SELECT numrange(3.5, 7.5, false, false) = numrange('(3.5,7.5)');
----
true

query I
SELECT numrange(3.5, 7.5, true, true) = numrange('[3.5,7.5]');
----
true

query I
SELECT numrange(3.5, 7.5, false, true) = numrange('(3.5,7.5]');
----
true
