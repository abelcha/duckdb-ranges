# name: test/sql/ranges.test
# description: test ranges extension
# group: [ranges]

# Before we load the extension, this will fail
statement error
SELECT int4range(1, 5);
----
Catalog Error: Scalar Function with name int4range does not exist!

# Require statement will ensure this test is run with this extension loaded
require ranges

# Test basic construction and display
query I
SELECT int4range(1, 5, '[)');
----
[1,5)

query I
SELECT int4range(1, 5, '[]');
----
[1,5]

query I
SELECT int4range(1, 5, '()');
----
(1,5)

query I
SELECT int4range(1, 5, '(]');
----
(1,5]

# Test empty ranges
query I
SELECT int4range(5, 1, '[)');
----
empty

query I
SELECT int4range(1, 1, '()');
----
empty

query I
SELECT int4range(1, 1, '[)');
----
empty

query I
SELECT int4range(1, 1, '(]');
----
empty

query I
SELECT int4range(1, 1, '[]');
----
[1,1]

# Test with negative numbers
query I
SELECT int4range(-10, -5, '[)');
----
[-10,-5)

query I
SELECT int4range(-5, 5, '[]');
----
[-5,5]

# Test with zero
query I
SELECT int4range(0, 10, '[)');
----
[0,10)

query I
SELECT int4range(-10, 0, '(]');
----
(-10,0]

# Test overlaps - basic cases
query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(3, 7, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(5, 10, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(5, 10, '[]'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(6, 10, '[)'));
----
false

# Test overlaps - edge cases with different bound combinations
query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(5, 10, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(5, 10, '[]'));
----
false

query I
SELECT range_overlaps(int4range(1, 5, '(]'), int4range(5, 10, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '()'), int4range(5, 10, '()'));
----
false

# Test overlaps - complete overlap
query I
SELECT range_overlaps(int4range(1, 10, '[)'), int4range(3, 7, '[)'));
----
true

query I
SELECT range_overlaps(int4range(3, 7, '[)'), int4range(1, 10, '[)'));
----
true

# Test overlaps - identical ranges
query I
SELECT range_overlaps(int4range(1, 5, '[)'), int4range(1, 5, '[)'));
----
true

query I
SELECT range_overlaps(int4range(1, 5, '[]'), int4range(1, 5, '[]'));
----
true

# Test overlaps - with empty ranges
query I
SELECT range_overlaps(int4range(5, 1, '[)'), int4range(1, 10, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 10, '[)'), int4range(5, 1, '[)'));
----
false

query I
SELECT range_overlaps(int4range(1, 1, '()'), int4range(1, 5, '[)'));
----
false

# Test overlaps - negative numbers
query I
SELECT range_overlaps(int4range(-10, -5, '[)'), int4range(-7, -3, '[)'));
----
true

query I
SELECT range_overlaps(int4range(-10, -5, '[)'), int4range(-5, 0, '[)'));
----
false

query I
SELECT range_overlaps(int4range(-10, 0, '[]'), int4range(0, 10, '[]'));
----
true

# Test NULLs
query I
SELECT int4range(NULL, 5, '[)');
----
NULL

query I
SELECT int4range(1, NULL, '[)');
----
NULL

query I
SELECT int4range(1, 5, NULL);
----
NULL

query I
SELECT range_overlaps(NULL, int4range(1, 5, '[)'));
----
NULL

query I
SELECT range_overlaps(int4range(1, 5, '[)'), NULL);
----
NULL

query I
SELECT range_overlaps(NULL, NULL);
----
NULL

# Test invalid bounds string (should error)
statement error
SELECT int4range(1, 5, 'invalid');
----
Invalid bounds: invalid

# Test that empty string defaults to [)
query I
SELECT int4range(1, 5, '');
----
[1,5)

# Test casting to VARCHAR works
query I
SELECT int4range(10, 20, '[]')::VARCHAR;
----
[10,20]

query I
SELECT int4range(10, 20, '()')::VARCHAR;
----
(10,20)

# Test range_contains function
query I
SELECT range_contains(int4range(1, 10, '[)'), 5);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 1);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 10);
----
false

query I
SELECT range_contains(int4range(1, 10, '[]'), 10);
----
true

query I
SELECT range_contains(int4range(1, 10, '()'), 1);
----
false

query I
SELECT range_contains(int4range(1, 10, '(]'), 10);
----
true

query I
SELECT range_contains(int4range(1, 10, '[)'), 0);
----
false

query I
SELECT range_contains(int4range(1, 10, '[)'), 11);
----
false

# Test range_contains with negative numbers
query I
SELECT range_contains(int4range(-10, 0, '[)'), -5);
----
true

query I
SELECT range_contains(int4range(-10, 0, '[)'), 0);
----
false

query I
SELECT range_contains(int4range(-10, 0, '[]'), 0);
----
true

# Test range_contains with empty ranges
query I
SELECT range_contains(int4range(5, 1, '[)'), 3);
----
false

# Test range_contains with NULL
query I
SELECT range_contains(NULL, 5);
----
NULL

query I
SELECT range_contains(int4range(1, 10, '[)'), NULL);
----
NULL


# Test 2-argument constructor (defaults to '[)')
query I
SELECT int4range(1, 5);
----
[1,5)

query I
SELECT int4range(10, 20);
----
[10,20)

query I
SELECT int4range(-5, 5);
----
[-5,5)

# Test lower() accessor
query I
SELECT lower(int4range(1, 10, '[)'));
----
1

query I
SELECT lower(int4range(-5, 5, '[]'));
----
-5

query I
SELECT lower(int4range(100, 200, '()'));
----
100

# Test upper() accessor
query I
SELECT upper(int4range(1, 10, '[)'));
----
10

query I
SELECT upper(int4range(-5, 5, '[]'));
----
5

query I
SELECT upper(int4range(100, 200, '()'));
----
200

# Test isempty() function
query I
SELECT isempty(int4range(1, 10, '[)'));
----
false

query I
SELECT isempty(int4range(5, 1, '[)'));
----
true

query I
SELECT isempty(int4range(1, 1, '[]'));
----
false

query I
SELECT isempty(int4range(1, 1, '[)'));
----
true

query I
SELECT isempty(int4range(1, 1, '()'));
----
true

# Test lower_inc() accessor
query I
SELECT lower_inc(int4range(1, 10, '[)'));
----
true

query I
SELECT lower_inc(int4range(1, 10, '()'));
----
false

query I
SELECT lower_inc(int4range(1, 10, '[]'));
----
true

query I
SELECT lower_inc(int4range(1, 10, '(]'));
----
false

# Test upper_inc() accessor
query I
SELECT upper_inc(int4range(1, 10, '[)'));
----
false

query I
SELECT upper_inc(int4range(1, 10, '()'));
----
false

query I
SELECT upper_inc(int4range(1, 10, '[]'));
----
true

query I
SELECT upper_inc(int4range(1, 10, '(]'));
----
true

# Test accessors with 2-arg constructor
query I
SELECT lower(int4range(5, 15));
----
5

query I
SELECT upper(int4range(5, 15));
----
15

query I
SELECT lower_inc(int4range(5, 15));
----
true

query I
SELECT upper_inc(int4range(5, 15));
----
false

# Test accessors with NULL
query I
SELECT lower(NULL::INT4RANGE);
----
NULL

query I
SELECT upper(NULL::INT4RANGE);
----
NULL

query I
SELECT isempty(NULL::INT4RANGE);
----
NULL

query I
SELECT lower_inc(NULL::INT4RANGE);
----
NULL

query I
SELECT upper_inc(NULL::INT4RANGE);
----
NULL

# Test 4-argument constructor
query I
SELECT int4range(1, 5, true, false);
----
[1,5)

query I
SELECT int4range(1, 5, true, true);
----
[1,5]

query I
SELECT int4range(1, 5, false, true);
----
(1,5]

query I
SELECT int4range(1, 5, false, false);
----
(1,5)

# Test 1-argument constructor and string casting
query I
SELECT int4range('[3,7)');
----
[3,7)

query I
SELECT int4range('(3,7)');
----
(3,7)

query I
SELECT int4range('[4,4]');
----
[4,4]

query I
SELECT int4range('[4,4)');
----
empty

query I
SELECT '[3,7)'::int4range;
----
[3,7)

query I
SELECT '(3,7)'::int4range;
----
(3,7)

query I
SELECT '[4,4]'::int4range;
----
[4,4]

query I
SELECT '[4,4)'::int4range;
----
empty

query I
SELECT 'empty'::int4range;
----
empty

query I
SELECT int4range('empty');
----
empty

statement error
SELECT int4range('invalid');
----
Malformed range literal: "invalid"

statement error
SELECT 'invalid'::int4range;
----
Malformed range literal: "invalid"


# Test consistency between constructors
query I
SELECT int4range(3, 7, '[)') = int4range('[3,7)');
----
true

query I
SELECT int4range(3, 7, false, false) = int4range('(3,7)');
----
true
